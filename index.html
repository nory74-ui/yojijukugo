<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÂõõÂ≠óÁÜüË™û BATTLE MASTER</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&display=swap');
        
        :root {
            --card-size: clamp(3.2rem, 16vw, 5rem);
            --neon-purple: #a855f7;
            --neon-blue: #3b82f6;
            --neon-pink: #ec4899;
        }

        body {
            font-family: 'Noto Sans JP', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 100%);
            color: #f8fafc;
            touch-action: manipulation;
            overscroll-behavior: none;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .glass-panel {
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .drop-zone {
            width: var(--card-size);
            height: var(--card-size);
            border: 2px dashed rgba(255, 255, 255, 0.2);
            border-radius: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.03);
            transition: all 0.2s;
            position: relative;
        }

        .drop-zone.drag-over {
            background: rgba(168, 85, 247, 0.2);
            border-color: var(--neon-purple);
            transform: scale(1.05);
        }

        .kanji-card {
            width: calc(var(--card-size) * 0.9);
            height: calc(var(--card-size) * 0.9);
            background: linear-gradient(145deg, #ffffff, #e2e8f0);
            border-radius: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: calc(var(--card-size) * 0.5);
            font-weight: 900;
            color: #1e293b;
            cursor: grab;
            box-shadow: 0 4px 0 #cbd5e1, 0 8px 15px rgba(0,0,0,0.3);
            user-select: none;
            z-index: 10;
        }

        .kanji-card.dragging { opacity: 0.5; transform: scale(0.9); }

        .correct-card { 
            background: linear-gradient(145deg, #10b981, #059669) !important; 
            color: white !important; 
            box-shadow: 0 4px 0 #047857 !important;
        }
        .wrong-card { 
            background: linear-gradient(145deg, #ef4444, #dc2626) !important; 
            color: white !important; 
            box-shadow: 0 4px 0 #b91c1c !important;
        }

        .btn-push {
            position: relative;
            transition: all 0.1s;
            border-bottom: 4px solid rgba(0,0,0,0.3);
        }
        .btn-push:active {
            transform: translateY(2px);
            border-bottom-width: 2px;
        }

        #source-area::-webkit-scrollbar { display: none; }
        
        @keyframes reveal {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        .animate-reveal { animation: reveal 0.3s ease-out forwards; }

        .answer-hint {
            position: absolute;
            bottom: -1.8rem;
            font-size: 0.75rem;
            font-weight: 900;
            color: #10b981;
            white-space: nowrap;
        }

        /* „Çø„Ç§„É†„É™„Éü„ÉÉ„Éà„Éê„Éº */
        #timer-bar-container {
            width: 100%;
            background: rgba(255, 255, 255, 0.1);
            height: 6px;
            overflow: hidden;
        }
        #timer-bar {
            height: 100%;
            width: 100%;
            background: linear-gradient(to right, var(--neon-blue), var(--neon-pink));
            box-shadow: 0 0 10px var(--neon-pink);
            transition: width 0.1s linear;
        }

        /* „Çπ„É©„Ç§„ÉÄ„Éº„ÅÆ„Ç´„Çπ„Çø„Éû„Ç§„Ç∫ */
        input[type=range] {
            accent-color: var(--neon-purple);
        }
    </style>
</head>
<body class="p-2 sm:p-4">

    <div id="app" class="w-full max-w-md md:max-w-2xl lg:max-w-3xl glass-panel rounded-[2.5rem] shadow-2xl overflow-hidden flex flex-col border border-white/10">
        
        <!-- „Éò„ÉÉ„ÉÄ„Éº -->
        <div class="bg-gradient-to-r from-purple-600 via-indigo-600 to-blue-600 p-6 text-white text-center relative">
            <h1 class="text-2xl sm:text-3xl font-black italic tracking-tighter">ÂõõÂ≠óÁÜüË™û BATTLE MASTER</h1>
            <p id="level-title" class="text-indigo-200 text-xs sm:text-sm mt-1 font-bold uppercase tracking-widest">„Çø„Ç§„É†„ÇíÁ´∂„ÅÑ„ÄÅ„Éû„Çπ„Çø„Éº„ÇíÁõÆÊåá„Åõ</p>
        </div>

        <!-- „Çø„Ç§„É†„Éê„Éº -->
        <div id="timer-bar-container" class="hidden">
            <div id="timer-bar"></div>
        </div>

        <div class="flex-1 overflow-y-auto p-4 sm:p-8">
            
            <!-- „Çπ„Çø„Éº„ÉàÁîªÈù¢ -->
            <div id="start-view" class="flex flex-col gap-6">
                <!-- Âà∂ÈôêÊôÇÈñìË®≠ÂÆö„Ç®„É™„Ç¢ -->
                <div class="bg-black/20 p-6 rounded-3xl border border-white/5 shadow-inner">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-black text-indigo-300 uppercase tracking-widest text-sm">Timer Settings</h3>
                        <span id="time-val-display" class="font-black text-xl text-white italic">15Áßí</span>
                    </div>
                    <input type="range" id="time-slider" min="5" max="65" step="5" value="15" class="w-full h-2 bg-white/10 rounded-lg appearance-none cursor-pointer mb-2">
                    <div class="flex justify-between text-[10px] font-bold text-indigo-400">
                        <span>FAST (5s)</span>
                        <span>OFF (No Limit)</span>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <button onclick="initGame('low')" class="btn-push bg-emerald-500 hover:bg-emerald-400 text-white font-black py-4 rounded-2xl shadow-lg transition text-lg">
                        ÂàùÁ¥ö (Â∞èÂ≠¶Áîü)
                    </button>
                    <button onclick="initGame('mid')" class="btn-push bg-sky-500 hover:bg-sky-400 text-white font-black py-4 rounded-2xl shadow-lg transition text-lg">
                        ‰∏≠Á¥ö (È´òÂ≠¶Âπ¥)
                    </button>
                    <button onclick="initGame('high')" class="btn-push bg-indigo-500 hover:bg-indigo-400 text-white font-black py-4 rounded-2xl shadow-lg transition text-lg">
                        ‰∏äÁ¥ö (‰∏≠Â≠¶Áîü)
                    </button>
                    <button onclick="initGame('hard')" class="btn-push bg-purple-600 hover:bg-purple-500 text-white font-black py-4 rounded-2xl shadow-lg transition text-lg">
                        Ë∂ÖÁ¥ö (È´òÊ†°Áîü)
                    </button>
                    <button onclick="initGame('legend')" class="md:col-span-2 btn-push bg-slate-800 hover:bg-slate-700 text-white font-black py-4 rounded-2xl shadow-lg transition text-lg border-slate-900">
                        ‰ºùË™¨ (Â§ß‰∫∫Âêë„Åë)
                    </button>
                </div>
            </div>

            <!-- „Ç≤„Éº„É†ÁîªÈù¢ -->
            <div id="game-view" class="hidden">
                <div class="text-center">
                    <div class="flex justify-between items-center mb-6">
                        <span id="q-count" class="text-xs font-black text-purple-400 bg-purple-900/50 px-3 py-1 rounded-full border border-purple-500/30 tracking-widest">STAGE 0/5</span>
                        <span class="text-xs font-black text-blue-400 tracking-widest uppercase">Score: <span id="current-score">0</span></span>
                    </div>
                    
                    <div class="p-5 sm:p-8 bg-black/40 rounded-3xl border border-white/5 shadow-inner mb-8 min-h-[6rem] flex items-center justify-center relative overflow-hidden">
                        <p id="q-meaning" class="text-white text-base sm:text-xl font-bold leading-relaxed italic z-10"></p>
                    </div>

                    <div id="drop-area" class="flex justify-center gap-2 sm:gap-4 mb-12">
                        <div class="drop-zone" data-idx="0"></div>
                        <div class="drop-zone" data-idx="1"></div>
                        <div class="drop-zone" data-idx="2"></div>
                        <div class="drop-zone" data-idx="3"></div>
                    </div>
                </div>

                <div id="source-area" class="p-4 bg-black/20 rounded-3xl flex flex-wrap justify-center gap-2 sm:gap-3 min-h-[9rem] items-center border border-white/5 shadow-inner mb-8">
                </div>

                <div class="flex flex-col gap-4">
                    <button id="check-btn" onclick="processAnswer()" class="btn-push w-full bg-gradient-to-r from-purple-600 to-indigo-600 text-white font-black py-4 rounded-2xl shadow-xl transition disabled:opacity-30 text-xl uppercase tracking-widest">
                        Á≠î„ÅàÂêà„Çè„Åõ
                    </button>
                    <div id="feedback" class="hidden text-center py-2 font-black text-2xl italic tracking-tighter"></div>
                    <button id="next-btn" onclick="nextQuestion()" class="hidden btn-push w-full bg-white text-indigo-900 font-black py-4 rounded-2xl shadow-xl transition text-xl uppercase tracking-widest">
                        Ê¨°„ÅÆ„Çπ„ÉÜ„Éº„Ç∏„Å∏
                    </button>
                </div>
            </div>

            <!-- „É™„Ç∂„É´„ÉàÁîªÈù¢ -->
            <div id="result-view" class="hidden text-center py-8">
                <div class="text-7xl mb-6 animate-bounce">üèÜ</div>
                <h2 class="text-3xl font-black text-white mb-2 uppercase tracking-tighter">Battle Completed</h2>
                <div class="bg-white/5 p-8 rounded-3xl border border-white/10 mb-8 inline-block min-w-[240px]">
                    <p class="text-xs font-black text-indigo-400 uppercase tracking-widest mb-2">Final Score</p>
                    <div class="text-6xl font-black text-white">
                        <span id="final-score">0</span><span class="text-2xl text-indigo-400 mx-1">/</span>5
                    </div>
                </div>
                <button onclick="resetToTitle()" class="btn-push w-full bg-gradient-to-r from-indigo-500 to-blue-500 text-white font-black py-5 rounded-2xl shadow-xl transition text-xl uppercase tracking-widest">
                    „Çø„Ç§„Éà„É´„Å∏Êàª„Çã
                </button>
            </div>
        </div>
    </div>

    <script>
        // ÂïèÈ°å„Éó„Éº„É´
        const masterIdioms = {
            low: [
                { i: "‰∏ÄÁü≥‰∫åÈ≥•", m: "‰∏Ä„Å§„ÅÆË°åÂãï„Åß‰∫å„Å§„ÅÆÂà©Áõä„ÇíÂæó„Çã„Åì„Å®„ÄÇ", d: ["‰∏â", "Áü≥", "È≠ö"] },
                { i: "ÂçÅ‰∫∫ÂçÅËâ≤", m: "Â•Ω„Åø„ÇÑËÄÉ„Åà„ÅØ‰∫∫„Å´„Çà„Å£„Å¶„Åù„Çå„Åû„ÇåÈÅï„ÅÜ„Åì„Å®„ÄÇ", d: ["Áôæ", "ÂçÉ", "‰∏á"] },
                { i: "Âè≥ÂæÄÂ∑¶ÂæÄ", m: "Ê∑∑‰π±„Åó„Å¶„ÅÇ„Å°„Åì„Å°„Å∏ÈÄÉ„Åí„Åæ„Çè„Çã„Åì„Å®„ÄÇ", d: ["Êù±", "Âçó", "Âåó"] },
                { i: "‰∏ÉËª¢ÂÖ´Ëµ∑", m: "‰ΩïÂ∫¶Â§±Êïó„Åó„Å¶„ÇÇ„ÄÅ„ÅÇ„Åç„Çâ„ÇÅ„Åö„Å´Á´ã„Å°‰∏ä„Åå„Çã„Åì„Å®„ÄÇ", d: ["‰∏ç", "ÂÄí", "ËêΩ"] },
                { i: "‰∏âÊó•Âùä‰∏ª", m: "È£Ω„Åç„ÇÑ„Åô„Åè„Å¶Èï∑Á∂ö„Åç„Åó„Å™„ÅÑ„Åì„Å®„ÄÇ", d: ["Âõõ", "Â§©", "Áéã"] },
                { i: "Êò•Â§èÁßãÂÜ¨", m: "‰∏ÄÂπ¥„ÅÆÂõõÂ≠£„ÅÆ„ÅÜ„Å§„Çä„Åã„Çè„Çä„ÄÇ", d: ["Â±±", "Â∑ù", "Êµ∑"] },
                { i: "‰∏ÄÁîüÊá∏ÂëΩ", m: "ÂëΩ„Çí„Åã„Åë„Çã„Åª„Å©ÂÖ®Âäõ„ÅßÂèñ„ÇäÁµÑ„ÇÄ„Åì„Å®„ÄÇ", d: ["ÂøÉ", "Ë∫´", "Ê∞ó"] },
                { i: "‰∏ÄÈï∑‰∏ÄÁü≠", m: "ËâØ„ÅÑ„Å®„Åì„Çç„ÇÇ„ÅÇ„Çã„ÅåÊÇ™„ÅÑ„Å®„Åì„Çç„ÇÇ„ÅÇ„Çã„Åì„Å®„ÄÇ", d: ["‰∫å", "‰∏â", "Èï∑"] },
                { i: "ÂÜç‰∏âÂÜçÂõõ", m: "‰ΩïÂ∫¶„ÇÇ‰ΩïÂ∫¶„ÇÇÁπ∞„ÇäËøî„Åô„Åì„Å®„ÄÇ", d: ["‰∏Ä", "‰∫å", "Â∫¶"] },
                { i: "‰∏ÄÂøÉ‰∏ç‰π±", m: "ÂøÉ„Çí‰∏Ä„Å§„ÅÆ„Åì„Å®„Å´ÈõÜ‰∏≠„Åó„Å¶‰π±„Çå„Å™„ÅÑ„Åì„Å®„ÄÇ", d: ["Á•û", "‰ø°", "ÂàÜ"] },
                { i: "Êó•ÈÄ≤ÊúàÊ≠©", m: "Áµ∂„ÅàÈñì„Å™„ÅèÊÄ•ÈÄü„Å´ÈÄ≤Ê≠©„Åô„Çã„Åì„Å®„ÄÇ", d: ["Âπ¥", "Â§©", "ÊôÇ"] },
                { i: "Êú¨Êú´Ëª¢ÂÄí", m: "Â§ß‰∫ã„Å™„Åì„Å®„Å®„Åù„ÅÜ„Åß„Å™„ÅÑ„Åì„Å®„ÇíÂèñ„ÇäÈÅï„Åà„Çã„Åì„Å®„ÄÇ", d: ["ÈÄÜ", "Ê≠£", "È†≠"] },
                { i: "Ëá™Áî±Ëá™Âú®", m: "Ëá™ÂàÜ„ÅÆÊÄù„ÅÜÈÄö„Çä„Å´ÊåØ„ÇãËàû„ÅÜ„Åì„Å®„ÄÇ", d: ["Ë°å", "Âãï", "Áî±"] },
                { i: "‰∏ÄÂñú‰∏ÄÊÜÇ", m: "Áä∂Ê≥Å„ÅåÂ§â„Çè„Çã„Åü„Å≥„Å´Âñú„Çì„Å†„ÇäÂøÉÈÖç„Åó„Åü„Çä„Åô„Çã„Åì„Å®„ÄÇ", d: ["‰∫å", "Ê•Ω", "ÊÇ≤"] }
            ],
            mid: [
                { i: "‰ª•ÂøÉ‰ºùÂøÉ", m: "Ë®ÄËëâ„Çí‰Ωø„Çè„Å™„Åè„Å¶„ÇÇÊ∞óÊåÅ„Å°„ÅåÈÄö„ÅòÂêà„ÅÜ„Åì„Å®„ÄÇ", d: ["Áúü", "‰ø°", "Êñ∞"] },
                { i: "Âº±ËÇâÂº∑È£ü", m: "Âº∑„ÅÑËÄÖ„ÅåÂº±„ÅÑËÄÖ„ÇíÈ£ü„Åπ„Å¶Ê†Ñ„Åà„Çã„Åì„Å®„ÄÇ", d: ["Áâõ", "È≠ö", "Ë∫´"] },
                { i: "Ê∏©ÊïÖÁü•Êñ∞", m: "Âè§„ÅÑ„Åì„Å®„ÇíÂ≠¶„Å≥„ÄÅÊñ∞„Åó„ÅÑÁü•Ë≠ò„ÇíÂæó„Çã„Åì„Å®„ÄÇ", d: ["Âú∞", "Êô∫", "Ê±†"] },
                { i: "Áµ∂‰ΩìÁµ∂ÂëΩ", m: "ËøΩ„ÅÑË©∞„ÇÅ„Çâ„Çå„Å¶ÈÄÉ„ÅíÂ†¥„Åå„Å™„ÅÑ„ÄÅÂ§ß„Éî„É≥„ÉÅ„ÅÆÁä∂ÊÖã„ÄÇ", d: ["ÂØæ", "ÂëΩ", "Êòé"] },
                { i: "Ëá™ÂïèËá™Á≠î", m: "Ëá™ÂàÜ„ÅßËá™ÂàÜ„Å´Âïè„ÅÑ„Åã„Åë„ÄÅËá™ÂàÜ„ÅßÁ≠î„Åà„ÇíÂá∫„Åô„Åì„Å®„ÄÇ", d: ["Âïè", "Á≠î", "Ë™û"] },
                { i: "Âç±Ê©ü‰∏ÄÈ´™", m: "ÈùûÂ∏∏„Å´Âç±Èô∫„Å™„ÄÅ„Åç„Çè„Å©„ÅÑÁÄ¨Êà∏Èöõ„ÅÆ„Åì„Å®„ÄÇ", d: ["‰∏Ä", "Ê©ü", "Áô∫"] },
                { i: "ÂèñÊç®ÈÅ∏Êäû", m: "ËâØ„ÅÑ„ÇÇ„ÅÆ„ÇíÂèñ„Çä„ÄÅÊÇ™„ÅÑ„ÇÇ„ÅÆ„ÇíÊç®„Å¶„Çã„Åì„Å®„ÄÇ", d: ["ÈÅ∏", "Êé°", "Ê±∫"] },
                { i: "ÈáùÂ∞èÊ£íÂ§ß", m: "Áâ©‰∫ã„ÇíÂ§ß„Åí„Åï„Å´Ë®Ä„ÅÜ„Åì„Å®„ÄÇ", d: ["Â§ß", "Â∞è", "Ë©±"] },
                { i: "ÂëâË∂äÂêåËàü", m: "ÊïµÂêåÂ£´„ÅåÂêå„ÅòÂ†¥ÊâÄ„ÅßÂä©„ÅëÂêà„ÅÜ„Åì„Å®„ÄÇ", d: ["Ëàπ", "Âèã", "Êµ∑"] },
                { i: "‰∫îÈáåÈúß‰∏≠", m: "ÊßòÂ≠ê„ÅåÂàÜ„Åã„Çâ„Åö„ÄÅÊñπÈáù„ÅåÁ´ã„Åü„Å™„ÅÑ„Åì„Å®„ÄÇ", d: ["Â±±", "Èõ≤", "Á©∫"] },
                { i: "ÈÅ©ÊùêÈÅ©ÊâÄ", m: "ÊâçËÉΩ„Å´Âêà„Å£„ÅüÂΩπÂâ≤„Çí‰∏é„Åà„Çã„Åì„Å®„ÄÇ", d: ["‰∫∫", "Êùê", "Â†¥"] },
                { i: "ÊâçËâ≤ÂÖºÂÇô", m: "„Åô„Åê„Çå„ÅüÊâçËÉΩ„Å®Áæé„Åó„ÅÑÈ°îÁ´ã„Å°„ÅÆ‰∏°Êñπ„ÇíÊåÅ„Å§„Åì„Å®„ÄÇ", d: ["Áæé", "Â•≥", "ÂÖº"] }
            ],
            high: [
                { i: "Ë©¶Ë°åÈåØË™§", m: "Â§±Êïó„ÇíÁπ∞„ÇäËøî„Åó„Å™„Åå„ÇâÊ≠£Ëß£„Å´Ëøë„Å•„Åè„Åì„Å®„ÄÇ", d: ["Ê†°", "Á≠ñ", "Âæå"] },
                { i: "Á¥Ü‰ΩôÊõ≤Êäò", m: "‰∫ãÊÉÖ„ÅåË§áÈõë„Åß„ÄÅÁâ©‰∫ã„Åå„Åô„Çì„Å™„ÇäÈÅã„Å∞„Å™„ÅÑ„Åì„Å®„ÄÇ", d: ["Âè≥", "Â∑¶", "Áõ¥"] },
                { i: "Ëá•Ëñ™ÂòóËÉÜ", m: "ÁõÆÁöÑ„ÅÆ„Åü„ÇÅ„Å´„ÄÅËã¶Âä¥„Å´ËÄê„Åà„Å¶Âä™Âäõ„ÅóÁ∂ö„Åë„Çã„Åì„Å®„ÄÇ", d: ["ÂøÉ", "Ë´á", "Ëã¶"] },
                { i: "ÂàáÁ£ãÁê¢Á£®", m: "‰ª≤ÈñìÂêåÂ£´„ÅßÂä±„Åæ„ÅóÂêà„ÅÑ„ÄÅÂêë‰∏ä„Åô„Çã„Åì„Å®„ÄÇ", d: ["Á†î", "Á©∂", "Á∑¥"] },
                { i: "ÊîØÈõ¢ÊªÖË£Ç", m: "Á≠ãÈÅì„ÅåÁ´ã„Åü„Åö„Éê„É©„Éê„É©„Å™„Åì„Å®„ÄÇ", d: ["Â£ä", "‰π±", "ÊªÖ"] },
                { i: "ÊÑèÊ∞óÊèö„ÄÖ", m: "ÂæóÊÑè„Åí„Åß„ÄÅÂÖÉÊ∞ó„ÅÑ„Å£„Å±„ÅÑ„Å´ÊåØ„ÇãËàû„ÅÜ„Åï„Åæ„ÄÇ", d: ["Áîü", "ÈÅì", "Âêà"] },
                { i: "Âõ†ÊûúÂøúÂ†±", m: "Ë°åÁÇ∫„Å´Âøú„Åò„ÅüÂ†±„ÅÑ„ÅåÂøÖ„ÅöÁèæ„Çå„Çã„Åì„Å®„ÄÇ", d: ["Ë∫´", "Êûú", "Â†±"] },
                { i: "ÁñëÂøÉÊöóÈ¨º", m: "Áñë„ÅÑÂá∫„Åô„Å®„ÄÅ‰Ωï„Åß„ÇÇ„Å™„ÅÑ„Åì„Å®„Åæ„ÅßÊÅê„Çç„Åó„Åè„Å™„Çã„Åì„Å®„ÄÇ", d: ["‰ø°", "Áúü", "È¨º"] },
                { i: "Ë´∏Ë°åÁÑ°Â∏∏", m: "„Åì„ÅÆ‰∏ñ„ÅÆ„Åô„Åπ„Å¶„ÅØÂ∏∏„Å´Â§â„Çè„ÇäÁ∂ö„Åë„Çã„Åì„Å®„ÄÇ", d: ["ÂÆö", "ÊÄß", "ÂøÉ"] },
                { i: "ÁîªÁ´úÁÇπÁùõ", m: "ÊúÄÂæå„ÅÆÂ§ß‰∫ã„Å™‰ªï‰∏ä„Åí„Çí„Åô„Çã„Åì„Å®„ÄÇ", d: ["Á≤æ", "Êòü", "Êô¥"] },
                { i: "Êú¨Êú´Ëª¢ÂÄí", m: "Â§ß‰∫ã„Å™„Åì„Å®„Å®„Å§„Åæ„Çâ„Å™„ÅÑ„Åì„Å®„ÅåÈÄÜ„Å´„Å™„Çã„Åì„Å®„ÄÇ", d: ["ÈÄÜ", "Ê≠£", "È†≠"] },
                { i: "Ëá®Ê©üÂøúÂ§â", m: "Áä∂Ê≥Å„ÅÆÂ§âÂåñ„Å´Âøú„Åò„Å¶„ÄÅÈÅ©Âàá„Å™ÂØæÂøú„Çí„Åô„Çã„Åì„Å®„ÄÇ", d: ["Â∏∏", "ÂøÉ", "ÂØæ"] }
            ],
            hard: [
                { i: "‰πæÂù§‰∏ÄÊì≤", m: "ÈÅãÂëΩ„ÇíË≥≠„Åë„Å¶„ÄÅ„ÅÆ„Çã„Åã„Åù„Çã„Åã„ÅÆÂ§ßÂãùË≤†„Çí„Åô„Çã„Åì„Å®„ÄÇ", d: ["Êã≥", "Âú∞", "Êäï"] },
                { i: "Ê≥∞ÁÑ∂Ëá™Ëã•", m: "‰Ωï„ÅåËµ∑„Åç„Å¶„ÇÇËêΩ„Å°ÁùÄ„ÅÑ„Å¶„ÅÑ„Å¶„ÄÅÂãï„Åò„Å™„ÅÑ„Åì„Å®„ÄÇ", d: ["Âπ≥", "ÂÆâ", "Èùô"] },
                { i: "ÊèõÈ™®Â•™ËÉé", m: "‰ªñ‰∫∫„ÅÆ‰ΩúÂìÅ„ÇíÂúüÂè∞„Å´„ÄÅÁã¨Ëá™ÊÄß„ÇíÂä†„Åà„Å¶Êñ∞„Åó„Åè„Åô„Çã„Åì„Å®„ÄÇ", d: ["‰Ωì", "Âåñ", "È™®"] },
                { i: "ÂéöÈ°îÁÑ°ÊÅ•", m: "„Åö„ÅÜ„Åö„ÅÜ„Åó„Åè„Å¶„ÄÅÊÅ•„ÇíÁü•„Çâ„Å™„ÅÑ„Åì„Å®„ÄÇ", d: ["Â•Ω", "Áü•", "ÊÅ•"] },
                { i: "Êöó‰∏≠Ê®°Á¥¢", m: "Êâã„Åå„Åã„Çä„Åå„Å™„ÅÑ‰∏≠„Åß„ÄÅ„ÅÇ„Çå„Åì„ÇåÊé¢„ÇäÊ±Ç„ÇÅ„Çã„Åì„Å®„ÄÇ", d: ["Èóá", "‰∏≠", "Ê±Ç"] },
                { i: "Á≤âÈ™®Á†ïË∫´", m: "Âäõ„ÅÆÈôê„Çä„ÄÅ‰∏ÄÁîüÊá∏ÂëΩ„Å´Â∞ΩÂäõ„Åô„Çã„Åì„Å®„ÄÇ", d: ["Ê≠ª", "Ëã¶", "Âäõ"] },
                { i: "Èõ≤Êï£ÈúßÊ∂à", m: "Èúß„ÅåÊ∂à„Åà„Çã„Çà„ÅÜ„Å´„ÄÅË∑°ÂΩ¢„ÇÇ„Å™„ÅèÊ∂à„Åà„Çã„Åì„Å®„ÄÇ", d: ["Êµ∑", "Á©∫", "Èõ™"] },
                { i: "‰∏çË®ÄÂÆüË°å", m: "„ÅÇ„Çå„Åì„ÇåË®Ä„Çè„Åö„Å´„ÄÅÈªô„Å£„Å¶ÂÆüË°å„Åô„Çã„Åì„Å®„ÄÇ", d: ["Êúâ", "Ë°å", "Ë®Ä"] },
                { i: "ÂÖ¨Âπ≥ÁÑ°ÁßÅ", m: "Ëá™ÂàÜ„ÅÆÊÑüÊÉÖ„ÇíÊåü„Åæ„Åö„ÄÅË™∞„Å´ÂØæ„Åó„Å¶„ÇÇÂπ≥Á≠â„Å™„Åì„Å®„ÄÇ", d: ["ÂÖ¨", "Ê≠£", "Âπ≥"] },
                { i: "Ê∏ÖÂªâÊΩîÁôΩ", m: "ÂøÉ„ÅåÊ∏Ö„Çâ„Åã„Åß„ÄÅÂ∞ë„Åó„ÅÆ‰∏çÊ≠£„ÇÇ„Å™„ÅÑ„Åì„Å®„ÄÇ", d: ["ÁôΩ", "Ê≠£", "Áõ¥"] }
            ],
            legend: [
                { i: "ËôöÂøÉÂù¶Êáê", m: "„Çè„Å†„Åã„Åæ„Çä„Åå„Å™„Åè„ÄÅ„Åï„Å£„Å±„Çä„Åó„ÅüÂøÉÂ¢É„ÅÆ„Åì„Å®„ÄÇ", d: ["ÂøÉ", "Êáê", "Ëôö"] },
                { i: "‰∏çÊíì‰∏çÂ±à", m: "„Å©„Çì„Å™Âõ∞Èõ£„Å´„ÅÇ„Å£„Å¶„ÇÇ„ÄÅÊ±∫„Åó„Å¶ÂøÉ„ÅåÊäò„Çå„Å™„ÅÑ„Åì„Å®„ÄÇ", d: ["Êíì", "‰∏ç", "Â±à"] },
                { i: "Èè°Ëä±Ê∞¥Êúà", m: "ÁõÆ„Å´„ÅØË¶ã„Åà„Çã„Åå„ÄÅÊâã„Å´Âèñ„Çã„Åì„Å®„Åå„Åß„Åç„Å™„ÅÑÂπª„ÄÇ", d: ["Êúà", "Ëä±", "Ê∞¥"] },
                { i: "ÂÇçËã•ÁÑ°‰∫∫", m: "Âë®„Çä„ÇíÊ∞ó„Å´„Åõ„Åö„ÄÅÂãùÊâãÊ∞ó„Åæ„Åæ„Å´ÊåØ„ÇãËàû„ÅÜ„Åì„Å®„ÄÇ", d: ["Âãù", "ÁÑ°", "‰∫∫"] },
                { i: "Ê£ÆÁæÖ‰∏áË±°", m: "ÂÆáÂÆô„Å´„ÅÇ„Çã„ÅÇ„Çâ„ÇÜ„Çã‰∫ãË±°„ÇÑÁèæË±°„ÅÆ„Åì„Å®„ÄÇ", d: ["Á•û", "ÁæÖ", "Â§©"] },
                { i: "Â®ÅÈ¢®Â†Ç„ÄÖ", m: "Â®ÅÂé≥„Åå„ÅÇ„Å£„Å¶„ÄÅÂ†Ç„ÄÖ„Å®„Åó„Å¶„ÅÑ„Çã„Åï„Åæ„ÄÇ", d: ["È¢®", "Â†Ç", "Á´ã"] },
                { i: "ÊäúÂ±±Ëìã‰∏ñ", m: "Â±±„ÇíÊäú„ÅçÂéª„Çä„ÄÅ‰∏ñ„ÇíË¶Ü„ÅÜ„Åª„Å©„ÅÆ‰∏¶Â§ñ„Çå„ÅüÂ®ÅÂäõ„ÄÇ", d: ["Êäú", "‰∏ñ", "Âº∑"] },
                { i: "ÁôæÈ¨ºÂ§úË°å", m: "ÊÇ™‰∫∫„Åü„Å°„Åå„ÄÅÂãùÊâãÊ∞ó„Åæ„Åæ„Å´Ê®™Ë°å„Åô„Çã„Åì„Å®„ÄÇ", d: ["Â§ú", "Ë°å", "È¨º"] },
                { i: "Â§èÁÇâÂÜ¨Êâá", m: "Â≠£ÁØÄÂ§ñ„Çå„Åß„ÄÅÂΩπ„Å´Á´ã„Åü„Å™„ÅÑ„ÇÇ„ÅÆ„ÅÆ‰æã„Åà„ÄÇ", d: ["ÁÇâ", "Êâá", "ÂÜ¨"] },
                { i: "‰ªòÂíåÈõ∑Âêå", m: "Ëá™ÂàÜ„ÅÆËÄÉ„Åà„Åå„Å™„Åè„ÄÅ‰ªñ‰∫∫„ÅÆÊÑèË¶ã„Å´„Åô„ÅêË≥õÊàê„Åô„Çã„Åì„Å®„ÄÇ", d: ["Âêå", "È¢®", "Èõ∑"] }
            ]
        };

        let currentLevel = '';
        let currentGameQuestions = [];
        let currentIdx = 0;
        let score = 0;
        let draggedCard = null;
        let timePerQuestion = 15;
        let currentSeconds = 0;
        let timerId = null;

        // View elements
        const startView = document.getElementById('start-view');
        const gameView = document.getElementById('game-view');
        const resultView = document.getElementById('result-view');
        const timeSlider = document.getElementById('time-slider');
        const timeValDisplay = document.getElementById('time-val-display');
        const checkBtn = document.getElementById('check-btn');
        const nextBtn = document.getElementById('next-btn');
        const feedback = document.getElementById('feedback');
        const dropArea = document.getElementById('drop-area');
        const sourceArea = document.getElementById('source-area');
        const timerBar = document.getElementById('timer-bar');
        const timerBarContainer = document.getElementById('timer-bar-container');

        // Timer Slider Logic
        timeSlider.addEventListener('input', (e) => {
            const val = parseInt(e.target.value);
            if (val > 60) {
                timeValDisplay.textContent = "ÁÑ°Âà∂Èôê";
                timePerQuestion = 0;
            } else {
                timeValDisplay.textContent = val + "Áßí";
                timePerQuestion = val;
            }
        });

        function shuffle(arr) {
            return arr.sort(() => Math.random() - 0.5);
        }

        function initGame(level) {
            currentLevel = level;
            // Get 5 random questions from pool
            currentGameQuestions = shuffle([...masterIdioms[level]]).slice(0, 5);
            currentIdx = 0;
            score = 0;
            document.getElementById('current-score').textContent = "0";
            
            startView.classList.add('hidden');
            resultView.classList.add('hidden');
            gameView.classList.remove('hidden');
            
            if (timePerQuestion > 0) {
                timerBarContainer.classList.remove('hidden');
            } else {
                timerBarContainer.classList.add('hidden');
            }
            
            document.getElementById('level-title').textContent = "BATTLE: " + level.toUpperCase();
            loadQuestion();
        }

        function loadQuestion() {
            const data = currentGameQuestions[currentIdx];
            document.getElementById('q-meaning').textContent = data.m;
            document.getElementById('q-count').textContent = `STAGE ${currentIdx + 1}/5`;
            
            feedback.classList.add('hidden');
            nextBtn.classList.add('hidden');
            checkBtn.classList.remove('hidden');
            checkBtn.disabled = true;

            sourceArea.innerHTML = '';
            Array.from(dropArea.children).forEach(zone => {
                zone.innerHTML = '';
                zone.className = 'drop-zone';
            });

            const idiomChars = data.i.split('');
            const uniqueChars = new Set(idiomChars);
            const safeDummies = data.d.filter(c => !uniqueChars.has(c));
            const finalCards = shuffle([...idiomChars, ...safeDummies]);

            finalCards.forEach((kanji, idx) => {
                const card = createCard(kanji, idx);
                sourceArea.appendChild(card);
            });

            setupDragEvents();
            startTimer();
        }

        function createCard(kanji, id) {
            const card = document.createElement('div');
            card.className = 'kanji-card animate-reveal';
            card.textContent = kanji;
            card.draggable = true;
            card.id = `card-${id}`;
            
            card.onclick = () => {
                if (checkBtn.classList.contains('hidden')) return;
                if (card.parentElement === sourceArea) {
                    const emptySlot = Array.from(dropArea.children).find(z => !z.hasChildNodes());
                    if (emptySlot) emptySlot.appendChild(card);
                } else {
                    sourceArea.appendChild(card);
                }
                validateState();
            };
            return card;
        }

        function startTimer() {
            if (timerId) clearInterval(timerId);
            if (timePerQuestion === 0) return;

            currentSeconds = timePerQuestion;
            timerBar.style.width = "100%";
            timerBar.style.transition = "none";
            
            timerId = setInterval(() => {
                currentSeconds -= 0.1;
                const percent = (currentSeconds / timePerQuestion) * 100;
                timerBar.style.width = percent + "%";
                timerBar.style.transition = "width 0.1s linear";

                if (currentSeconds <= 0) {
                    clearInterval(timerId);
                    processAnswer(true); // Times up
                }
            }, 100);
        }

        function setupDragEvents() {
            const cards = document.querySelectorAll('.kanji-card');
            cards.forEach(card => {
                card.addEventListener('dragstart', (e) => {
                    if (checkBtn.classList.contains('hidden')) return;
                    draggedCard = card;
                    card.classList.add('dragging');
                    e.dataTransfer.setData('text/plain', card.id);
                });
                card.addEventListener('dragend', () => card.classList.remove('dragging'));
            });

            [...dropArea.children, sourceArea].forEach(container => {
                container.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    if (container.classList.contains('drop-zone')) container.classList.add('drag-over');
                });
                container.addEventListener('dragleave', () => container.classList.remove('drag-over'));
                container.addEventListener('drop', (e) => {
                    e.preventDefault();
                    container.classList.remove('drag-over');
                    if (checkBtn.classList.contains('hidden')) return;

                    if (container.classList.contains('drop-zone')) {
                        if (container.hasChildNodes()) sourceArea.appendChild(container.firstChild);
                        container.appendChild(draggedCard);
                    } else {
                        sourceArea.appendChild(draggedCard);
                    }
                    validateState();
                });
            });
        }

        function validateState() {
            const isFull = Array.from(dropArea.children).every(z => z.hasChildNodes());
            checkBtn.disabled = !isFull;
        }

        function processAnswer(isTimeUp = false) {
            clearInterval(timerId);
            const data = currentGameQuestions[currentIdx];
            const zones = Array.from(dropArea.children);
            const userAns = zones.map(z => z.textContent).join('');
            const isCorrect = !isTimeUp && (userAns === data.i);

            zones.forEach((z, i) => {
                const card = z.firstChild;
                const correctChar = data.i[i];
                
                if (z.textContent === correctChar) {
                    if (card) card.classList.add('correct-card');
                } else {
                    if (card) card.classList.add('wrong-card');
                    
                    const hint = document.createElement('div');
                    hint.className = 'answer-hint';
                    hint.textContent = `Ê≠£Ëß£: ${correctChar}`;
                    z.appendChild(hint);
                }
                if (card) card.draggable = false;
            });

            if (isCorrect) {
                score++;
                document.getElementById('current-score').textContent = score;
                feedback.textContent = "MISSION COMPLETE! ‚ú®";
                feedback.className = "block text-emerald-400 animate-bounce";
            } else {
                feedback.textContent = isTimeUp ? "TIME UP! ‚åõ" : "MISSION FAILED...";
                feedback.className = "block text-rose-500";
            }

            feedback.classList.remove('hidden');
            checkBtn.classList.add('hidden');
            nextBtn.classList.remove('hidden');
        }

        function nextQuestion() {
            currentIdx++;
            if (currentIdx < 5) {
                loadQuestion();
            } else {
                showFinalResult();
            }
        }

        function showFinalResult() {
            timerBarContainer.classList.add('hidden');
            gameView.classList.add('hidden');
            resultView.classList.remove('hidden');
            document.getElementById('final-score').textContent = score;
            document.getElementById('level-title').textContent = "BATTLE FINISHED";
        }

        function resetToTitle() {
            // UI Switch
            resultView.classList.add('hidden');
            gameView.classList.add('hidden');
            startView.classList.remove('hidden');
            
            // Text Reset
            document.getElementById('level-title').textContent = "„Çø„Ç§„É†„ÇíÁ´∂„ÅÑ„ÄÅ„Éû„Çπ„Çø„Éº„ÇíÁõÆÊåá„Åõ";
            
            // State Clear
            if (timerId) clearInterval(timerId);
            timerBarContainer.classList.add('hidden');
        }
    </script>
</body>
</html>

