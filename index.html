<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÂõõÂ≠óÁÜüË™û„Éê„Éà„É´„Éû„Çπ„Çø„Éº</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&display=swap');
        
        :root {
            --card-base-size: clamp(3.2rem, 18vw, 5.5rem);
            --neon-purple: #a855f7;
            --neon-blue: #3b82f6;
            --neon-pink: #ec4899;
        }

        body {
            font-family: 'Noto Sans JP', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 100%);
            color: #f8fafc;
            touch-action: manipulation;
            overscroll-behavior: none;
            min-height: 100vh;
        }

        /* 3D„Éú„Çø„É≥ÂäπÊûú */
        .btn-push {
            position: relative;
            transition: all 0.1s;
            border-bottom: 4px solid rgba(0,0,0,0.3);
        }
        .btn-push:active {
            transform: translateY(2px);
            border-bottom-width: 2px;
        }

        .drop-zone {
            width: var(--card-base-size);
            height: var(--card-base-size);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 1.25rem;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(4px);
            transition: all 0.3s;
            flex-shrink: 0;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
        }

        .drop-zone.drag-over {
            background-color: rgba(168, 85, 247, 0.2);
            border-color: var(--neon-purple);
            box-shadow: 0 0 15px var(--neon-purple);
        }

        .kanji-card {
            width: calc(var(--card-base-size) * 0.9);
            height: calc(var(--card-base-size) * 0.9);
            background: linear-gradient(145deg, #ffffff, #e2e8f0);
            border-radius: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: calc(var(--card-base-size) * 0.5);
            font-weight: 900;
            color: #1e293b;
            cursor: grab;
            box-shadow: 0 4px 0 #cbd5e1, 0 8px 15px rgba(0,0,0,0.2);
            user-select: none;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .kanji-card.dragging {
            opacity: 0.7;
            transform: scale(1.1) rotate(5deg);
            z-index: 100;
        }

        .correct-zone { border-color: #10b981 !important; background-color: rgba(16, 185, 129, 0.1) !important; box-shadow: 0 0 20px rgba(16, 185, 129, 0.4); }
        .wrong-zone { border-color: #ef4444 !important; background-color: rgba(239, 68, 68, 0.1) !important; box-shadow: 0 0 20px rgba(239, 68, 68, 0.4); }
        
        .correct-card { 
            background: linear-gradient(145deg, #10b981, #059669) !important; 
            color: white !important; 
            border-color: transparent !important;
            box-shadow: 0 4px 0 #047857 !important;
        }
        .wrong-card { 
            background: linear-gradient(145deg, #ef4444, #dc2626) !important; 
            color: white !important; 
            border-color: transparent !important;
            box-shadow: 0 4px 0 #b91c1c !important;
        }

        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
        @keyframes shine {
            from { left: -100%; }
            to { left: 100%; }
        }
        .shimmer::after {
            content: "";
            position: absolute;
            top: 0; left: -100%;
            width: 50%; height: 100%;
            background: linear-gradient(to right, transparent, rgba(255,255,255,0.3), transparent);
            transform: skewX(-25deg);
            animation: shine 3s infinite;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-2 sm:p-4">

    <div id="app-container" class="w-full max-w-md md:max-w-2xl lg:max-w-3xl glass-panel rounded-[2.5rem] shadow-2xl overflow-hidden flex flex-col border border-white/10">
        
        <!-- „Éò„ÉÉ„ÉÄ„Éº -->
        <div id="header-bg" class="bg-gradient-to-r from-purple-600 via-indigo-600 to-blue-600 p-6 text-white text-center relative overflow-hidden">
            <div class="absolute inset-0 opacity-20 bg-[radial-gradient(circle_at_50%_120%,rgba(255,255,255,0.5),transparent)]"></div>
            <h1 class="text-2xl sm:text-3xl font-black italic tracking-tighter shimmer relative">ÂõõÂ≠óÁÜüË™û BATTLE Ê±∫ÂÆöÊà¶</h1>
            <p id="level-label" class="text-indigo-200 text-xs sm:text-sm mt-1 font-bold uppercase tracking-widest">„Éü„ÉÉ„Ç∑„Éß„É≥„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
        </div>

        <!-- „Éó„É≠„Ç∞„É¨„Çπ„Éê„Éº -->
        <div id="progress-container" class="hidden w-full bg-white/5 h-2">
            <div id="progress-bar" class="bg-gradient-to-r from-purple-400 to-pink-500 h-full transition-all duration-500 shadow-[0_0_10px_rgba(236,72,153,0.5)]" style="width: 0%"></div>
        </div>

        <div class="flex-1 overflow-y-auto p-4 sm:p-8">
            
            <!-- „É¨„Éô„É´ÈÅ∏ÊäûÁîªÈù¢ -->
            <div id="start-view" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <button onclick="startGame('elementary_low')" class="btn-push bg-emerald-500 hover:bg-emerald-400 text-white font-black py-5 rounded-2xl shadow-lg transition text-lg">
                    LV.1 ÂàùÁ¥ö
                </button>
                <button onclick="startGame('elementary_high')" class="btn-push bg-sky-500 hover:bg-sky-400 text-white font-black py-5 rounded-2xl shadow-lg transition text-lg">
                    LV.2 ‰∏≠Á¥ö
                </button>
                <button onclick="startGame('junior_high')" class="btn-push bg-indigo-500 hover:bg-indigo-400 text-white font-black py-5 rounded-2xl shadow-lg transition text-lg">
                    LV.3 ‰∏äÁ¥ö
                </button>
                <button onclick="startGame('high_school')" class="btn-push bg-purple-600 hover:bg-purple-500 text-white font-black py-5 rounded-2xl shadow-lg transition text-lg">
                    LV.4 Ë∂ÖÁ¥ö
                </button>
                <button onclick="startGame('adult')" class="md:col-span-2 btn-push bg-slate-800 hover:bg-slate-700 text-white font-black py-5 rounded-2xl shadow-lg transition text-lg border-slate-900">
                    LV.MAX „É¨„Ç∏„Çß„É≥„Éâ
                </button>
            </div>

            <!-- „Ç≤„Éº„É†ÁîªÈù¢ -->
            <div id="game-view" class="hidden">
                <div class="text-center">
                    <div class="flex justify-between items-center mb-4">
                        <span id="question-number" class="text-xs font-black text-purple-400 uppercase tracking-widest bg-purple-900/50 px-3 py-1 rounded-full border border-purple-500/30">QUEST 01</span>
                        <div class="flex gap-4">
                            <span class="text-xs font-black text-pink-400">TIME: <span id="timer-display">0.0</span>s</span>
                            <span class="text-xs font-black text-blue-400">SCORE: <span id="current-score-display">0</span></span>
                        </div>
                    </div>
                    
                    <div class="p-5 sm:p-7 bg-white/5 rounded-3xl border border-white/10 shadow-inner flex items-center justify-center min-h-[5rem]">
                        <p id="meaning-display" class="text-white text-base sm:text-lg font-bold leading-relaxed tracking-tight italic"></p>
                    </div>

                    <div id="drop-area" class="mt-8 flex justify-center gap-2 sm:gap-4 py-2">
                        <div class="drop-zone" data-index="0"></div>
                        <div class="drop-zone" data-index="1"></div>
                        <div class="drop-zone" data-index="2"></div>
                        <div class="drop-zone" data-index="3"></div>
                    </div>
                </div>

                <div class="mt-8">
                    <div id="source-area" class="p-5 bg-black/20 rounded-3xl flex flex-wrap justify-center gap-3 min-h-[10rem] items-center border border-white/5 shadow-inner"></div>
                </div>

                <div class="mt-8 flex flex-col gap-4">
                    <button id="check-btn" onclick="checkAnswer()" class="btn-push w-full bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-500 hover:to-indigo-500 text-white font-black py-4 rounded-2xl shadow-xl transition-all disabled:opacity-30 disabled:border-none text-xl uppercase tracking-tighter">
                        Á≠î„Åà„ÇíÁ¢∫Ë™ç
                    </button>
                    <div id="feedback-area" class="hidden text-center py-2">
                        <div id="feedback-message" class="font-black text-2xl drop-shadow-[0_0_10px_rgba(255,255,255,0.5)]"></div>
                    </div>
                    <button id="next-btn" onclick="nextQuestion()" class="hidden btn-push w-full bg-white text-indigo-900 font-black py-4 rounded-2xl shadow-xl transition-all text-xl uppercase tracking-tighter">
                        Ê¨°„ÅÆ„Éü„ÉÉ„Ç∑„Éß„É≥„Å∏
                    </button>
                </div>
            </div>

            <!-- „É™„Ç∂„É´„ÉàÁîªÈù¢ -->
            <div id="result-view" class="hidden text-center py-6">
                <div class="relative inline-block mb-6">
                    <div class="text-7xl animate-bounce">üèÜ</div>
                    <div class="absolute -inset-4 bg-purple-500/20 blur-xl rounded-full"></div>
                </div>
                <h2 class="text-3xl font-black text-white mb-2 uppercase tracking-tighter">„Éü„ÉÉ„Ç∑„Éß„É≥„Éª„ÇØ„É™„Ç¢</h2>
                <p id="result-comment" class="text-indigo-300 font-bold mb-8 italic"></p>
                
                <div class="grid grid-cols-2 gap-4 mb-10">
                    <div class="bg-white/5 p-4 rounded-3xl border border-white/10">
                        <p class="text-[10px] font-black text-indigo-400 uppercase tracking-widest mb-1">Ê≠£Ëß£Êï∞</p>
                        <div class="text-3xl font-black text-white"><span id="final-score">0</span><span class="text-base text-indigo-400 mx-1">/</span>5</div>
                    </div>
                    <div class="bg-white/5 p-4 rounded-3xl border border-white/10">
                        <p class="text-[10px] font-black text-pink-400 uppercase tracking-widest mb-1">„ÇØ„É™„Ç¢„Çø„Ç§„É†</p>
                        <div class="text-3xl font-black text-white"><span id="final-time">0.0</span><span class="text-base text-pink-400 ml-1">s</span></div>
                    </div>
                </div>

                <button onclick="backToMenu()" class="btn-push w-full bg-gradient-to-r from-indigo-500 to-blue-500 text-white font-black py-5 rounded-2xl shadow-xl transition text-xl tracking-tighter uppercase">
                    „É°„Éã„É•„Éº„Å´Êàª„Çã
                </button>
            </div>
        </div>
    </div>

    <script>
        // „ÇØ„Ç§„Ç∫„Éá„Éº„Çø
        const allQuizData = {
            elementary_low: [
                { idiom: "ÂçÅ‰∫∫ÂçÅËâ≤", meaning: "‰∫∫„Åù„Çå„Åû„Çå„ÄÅËÄÉ„Åà„ÇÑÂ•Ω„Åø„Åå„Å°„Åå„ÅÜ„Åì„Å®„ÄÇ", dummies: ["Áôæ", "ÂçÉ", "‰∏á"] },
                { idiom: "‰∏ÄÁü≥‰∫åÈ≥•", meaning: "‰∏Ä„Å§„ÅÆ„Åì„Å®„Åß„ÄÅ‰∫å„Å§„ÅÆÂæó„Çí„Åô„Çã„Åì„Å®„ÄÇ", dummies: ["‰∏â", "Áü≥", "È≠ö"] },
                { idiom: "Âè≥ÂæÄÂ∑¶ÂæÄ", meaning: "„ÅÜ„Çç„Åü„Åà„Å¶„ÄÅ„ÅÇ„Å°„Åì„Å°„Å∏Âãï„ÅçÂõû„Çã„Åì„Å®„ÄÇ", dummies: ["Êù±", "Âçó", "Âåó"] },
                { idiom: "‰∏ÉËª¢ÂÖ´Ëµ∑", meaning: "‰ΩïÂ∫¶Â§±Êïó„Åó„Å¶„ÇÇ„ÄÅ„ÅÇ„Åç„Çâ„ÇÅ„Å™„ÅÑ„Åì„Å®„ÄÇ", dummies: ["‰∏ç", "ÂÄí", "ËêΩ"] },
                { idiom: "Ëä±È≥•È¢®Êúà", meaning: "Ëá™ÁÑ∂„ÅÆÁæé„Åó„ÅÑÈ¢®ÊôØ„ÅÆ„Åì„Å®„ÄÇ", dummies: ["Â±±", "Â∑ù", "Ëçâ"] }
            ],
            elementary_high: [
                { idiom: "‰ª•ÂøÉ‰ºùÂøÉ", meaning: "Ë®ÄËëâ„Å´„Åó„Å™„Åè„Å¶„ÇÇ„ÄÅÁõ∏Êâã„Å®Ê∞óÊåÅ„Å°„ÅåÈÄö„Åò„Çã„Åì„Å®„ÄÇ", dummies: ["Áúü", "‰ø°", "Êñ∞"] },
                { idiom: "Âº±ËÇâÂº∑È£ü", meaning: "Âº∑„ÅÑËÄÖ„ÅåÂº±„ÅÑËÄÖ„ÇíÈ£ü„Åπ„Å¶Ê†Ñ„Åà„Çã„Åì„Å®„ÄÇ", dummies: ["Áâõ", "È≠ö", "Âäõ"] },
                { idiom: "Ê∏©ÊïÖÁü•Êñ∞", meaning: "Âè§„ÅÑ„Åì„Å®„ÇíÂ≠¶„Å≥„ÄÅÊñ∞„Åó„ÅÑÁü•Ë≠ò„ÇíÂæó„Çã„Åì„Å®„ÄÇ", dummies: ["Âú∞", "Êô∫", "Ê±†"] },
                { idiom: "ÂñúÊÄíÂìÄÊ•Ω", meaning: "‰∫∫Èñì„ÅåÊåÅ„Å§Êßò„ÄÖ„Å™ÊÑüÊÉÖ„ÅÆ„Åì„Å®„ÄÇ", dummies: ["ÊÑõ", "È©ö", "ÊÉÖ"] },
                { idiom: "ÂÖ¨ÊòéÊ≠£Â§ß", meaning: "Èö†„Åó„Åî„Å®„Åå„Å™„Åè„ÄÅÂ†Ç„ÄÖ„Å®„Åó„Å¶„ÅÑ„Çã„Åì„Å®„ÄÇ", dummies: ["Âπ≥", "Áõ¥", "ÂÖâ"] }
            ],
            junior_high: [
                { idiom: "Ëá™ÁîªËá™Ë≥õ", meaning: "Ëá™ÂàÜ„ÅÆ„Åó„Åü„Åì„Å®„ÇíËá™ÂàÜ„Åß„Åª„ÇÅ„Çã„Åì„Å®„ÄÇ", dummies: ["ÁÆó", "ÂèÇ", "Áî£"] },
                { idiom: "Ë©¶Ë°åÈåØË™§", meaning: "Â§±Êïó„ÇíÁπ∞„ÇäËøî„Åó„Å™„Åå„Çâ„ÄÅÊ≠£„Åó„ÅÑÊñπÊ≥ï„ÇíË¶ã„Å§„Åë„Çã„Åì„Å®„ÄÇ", dummies: ["Âêë", "Á≠ñ", "Âæå"] },
                { idiom: "Ë´∏Ë°åÁÑ°Â∏∏", meaning: "„Åì„ÅÆ‰∏ñ„ÅÆ„Åô„Åπ„Å¶„ÅØÂ∏∏„Å´Â§â„Çè„Çä„ÄÅÊ∞∏ÈÅ†„ÅÆ„ÇÇ„ÅÆ„ÅØ„Å™„ÅÑ„ÄÇ", dummies: ["ÂÆö", "ÊÄß", "ÂøÉ"] },
                { idiom: "ÂëâË∂äÂêåËàü", meaning: "ÊïµÂêåÂ£´„ÅåÂêå„ÅòÂ†¥ÊâÄ„Å´Âêà„Çè„Åõ„ÄÅÂä©„ÅëÂêà„ÅÜ„Åì„Å®„ÄÇ", dummies: ["Ëàπ", "Âèã", "Êµ∑"] },
                { idiom: "ÊÑèÊ∞óÊäïÂêà", meaning: "‰∫í„ÅÑ„Å´Ê∞óÊåÅ„Å°„Åå„Å¥„Å£„Åü„ÇäÂêà„ÅÜ„Åì„Å®„ÄÇ", dummies: ["ÂàÜ", "ÈÅì", "ÂøÉ"] }
            ],
            high_school: [
                { idiom: "Áµ∂‰ΩìÁµ∂ÂëΩ", meaning: "ËøΩ„ÅÑË©∞„ÇÅ„Çâ„Çå„Å¶ÈÄÉ„ÅíÂ†¥„Åå„Å™„ÅÑ„ÄÅÂ§ß„Éî„É≥„ÉÅ„ÅÆÁä∂ÊÖã„ÄÇ", dummies: ["ÂØæ", "ÂëΩ", "Êòé"] },
                { idiom: "Ëá•Ëñ™ÂòóËÉÜ", meaning: "ÁõÆÁöÑ„ÅÆ„Åü„ÇÅ„Å´„ÄÅËã¶Âä¥„Å´ËÄê„Åà„Å¶Âä™Âäõ„ÅóÁ∂ö„Åë„Çã„Åì„Å®„ÄÇ", dummies: ["ÂøÉ", "Ë´á", "Ëã¶"] },
                { idiom: "Èõ≤Êï£ÈúßÊ∂à", meaning: "Èúß„ÅåÊ∂à„Åà„Çã„Çà„ÅÜ„Å´„ÄÅË∑°ÂΩ¢„ÇÇ„Å™„ÅèÊ∂à„Åà„Çã„Åì„Å®„ÄÇ", dummies: ["Êµ∑", "Á©∫", "Èõ™"] },
                { idiom: "ÂéöÈ°îÁÑ°ÊÅ•", meaning: "„Åö„ÅÜ„Åö„ÅÜ„Åó„Åè„Å¶„ÄÅÊÅ•„ÇíÁü•„Çâ„Å™„ÅÑ„Åì„Å®„ÄÇ", dummies: ["Â•Ω", "Áü•", "ÊÅ•"] },
                { idiom: "Á¥Ü‰ΩôÊõ≤Êäò", meaning: "Áâ©‰∫ã„Åå„Åô„Çì„Å™„ÇäÈÅã„Å∞„Åö„ÄÅËæº„ÅøÂÖ•„Å£„Å¶„ÅÑ„Çã„Åì„Å®„ÄÇ", dummies: ["Âè≥", "Â∑¶", "Áõ¥"] }
            ],
            adult: [
                { idiom: "ÁñëÂøÉÊöóÈ¨º", meaning: "Áñë„ÅÜÂøÉ„ÅåÂº∑„Åè„Å™„Çã„Å®„ÄÅ„Å™„Çì„Åß„ÇÇ„Å™„ÅÑ„Åì„Å®„Åæ„ÅßÊÅê„Çç„Åó„Åè„Å™„Çã„Åì„Å®„ÄÇ", dummies: ["‰ø°", "Áúü", "È≠Ç"] },
                { idiom: "Ê≥∞ÁÑ∂Ëá™Ëã•", meaning: "‰Ωï„ÅåËµ∑„Åç„Å¶„ÇÇËêΩ„Å°ÁùÄ„ÅÑ„Å¶„ÅÑ„Å¶„ÄÅÂãï„Åò„Å™„ÅÑ„Åì„Å®„ÄÇ", dummies: ["Âπ≥", "ÂÆâ", "Èùô"] },
                { idiom: "‰πæÂù§‰∏ÄÊì≤", meaning: "ÈÅãÂëΩ„ÇíË≥≠„Åë„Å¶„ÄÅ„ÅÆ„Çã„Åã„Åù„Çã„Åã„ÅÆÂ§ßÂãùË≤†„Çí„Åô„Çã„Åì„Å®„ÄÇ", dummies: ["Êã≥", "Âú∞", "Êäï"] },
                { idiom: "ÊòéÈè°Ê≠¢Ê∞¥", meaning: "ÈÇ™Âøµ„Åå„Å™„Åè„ÄÅÈùô„Åã„Å´ÊæÑ„ÅøÂàá„Å£„ÅüÂøÉÂ¢É„ÅÆ„Åì„Å®„ÄÇ", dummies: ["Êúà", "Ê≥¢", "ÂÖâ"] },
                { idiom: "Êúù‰∏âÊöÆÂõõ", meaning: "ÁõÆÂÖà„ÅÆÈÅï„ÅÑ„Å´„Åì„Å†„Çè„Çä„ÄÅÊú¨Ë≥™„ÅåÂêå„Åò„Å†„Å®Ê∞ó„Å•„Åã„Å™„ÅÑ„ÄÇ", dummies: ["‰∫å", "‰∫î", "ÂÖ´"] }
            ]
        };

        const levelNames = {
            elementary_low: "LV.1 ÂàùÁ¥ö",
            elementary_high: "LV.2 ‰∏≠Á¥ö",
            junior_high: "LV.3 ‰∏äÁ¥ö",
            high_school: "LV.4 Ë∂ÖÁ¥ö",
            adult: "LV.MAX"
        };

        // Áä∂ÊÖãÂ§âÊï∞
        let currentLevel = '';
        let currentQuestionIndex = 0;
        let score = 0;
        let draggedElement = null;
        let currentLevelData = [];
        let startTime = 0;
        let timerInterval = null;
        let totalTime = 0;

        // „Éì„É•„ÉºÂà∂Âæ°
        const startGame = (level) => {
            currentLevel = level;
            currentLevelData = [...allQuizData[level]];
            currentQuestionIndex = 0;
            score = 0;
            totalTime = 0;
            document.getElementById('current-score-display').textContent = "0";

            document.getElementById('level-label').textContent = levelNames[level] + " ÂÆüË°å‰∏≠";
            document.getElementById('start-view').classList.add('hidden');
            document.getElementById('game-view').classList.remove('hidden');
            document.getElementById('progress-container').classList.remove('hidden');

            showQuestion();
            startTimer();
        };

        const startTimer = () => {
            startTime = Date.now();
            timerInterval = setInterval(() => {
                const elapsed = (Date.now() - startTime) / 1000;
                document.getElementById('timer-display').textContent = elapsed.toFixed(1);
            }, 100);
        };

        const stopTimer = () => {
            clearInterval(timerInterval);
            totalTime = (Date.now() - startTime) / 1000;
            return totalTime;
        };

        const showQuestion = () => {
            const data = currentLevelData[currentQuestionIndex];
            document.getElementById('meaning-display').textContent = data.meaning;
            document.getElementById('question-number').textContent = `QUEST ${String(currentQuestionIndex + 1).padStart(2, '0')}`;
            document.getElementById('progress-bar').style.width = `${(currentQuestionIndex / currentLevelData.length) * 100}%`;
            
            document.getElementById('feedback-area').classList.add('hidden');
            document.getElementById('next-btn').classList.add('hidden');
            const checkBtn = document.getElementById('check-btn');
            checkBtn.classList.remove('hidden');
            checkBtn.disabled = true;

            document.querySelectorAll('.drop-zone').forEach(zone => {
                zone.innerHTML = '';
                zone.classList.remove('correct-zone', 'wrong-zone');
            });

            const sourceArea = document.getElementById('source-area');
            sourceArea.innerHTML = '';
            
            // ÈáçË§áÂà∂Âæ°„É≠„Ç∏„ÉÉ„ÇØ
            const idiomChars = data.idiom.split(''); 
            const uniqueIdiomSet = new Set(idiomChars);
            const safeDummies = data.dummies.filter(d => !uniqueIdiomSet.has(d));
            const finalCards = shuffle([...idiomChars, ...safeDummies]);
            
            finalCards.forEach((kanji, i) => {
                const card = createCard(kanji, i);
                sourceArea.appendChild(card);
            });

            setupDragAndDrop();
        };

        const createCard = (kanji, id) => {
            const card = document.createElement('div');
            card.className = 'kanji-card';
            card.textContent = kanji;
            card.draggable = true;
            card.id = `card-${id}`;
            
            card.onclick = () => {
                if (!document.getElementById('next-btn').classList.contains('hidden')) return;
                const sourceArea = document.getElementById('source-area');
                if (card.parentElement === sourceArea) {
                    const empty = Array.from(document.querySelectorAll('.drop-zone')).find(z => !z.hasChildNodes());
                    if (empty) empty.appendChild(card);
                } else {
                    sourceArea.appendChild(card);
                }
                updateBtnState();
            };
            return card;
        };

        const setupDragAndDrop = () => {
            const cards = document.querySelectorAll('.kanji-card');
            cards.forEach(card => {
                card.addEventListener('dragstart', (e) => {
                    if (!document.getElementById('next-btn').classList.contains('hidden')) return;
                    draggedElement = card;
                    card.classList.add('dragging');
                });
                card.addEventListener('dragend', () => {
                    card.classList.remove('dragging');
                    updateBtnState();
                });
            });

            [...document.querySelectorAll('.drop-zone'), document.getElementById('source-area')].forEach(container => {
                container.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    if (container.classList.contains('drop-zone')) container.classList.add('drag-over');
                });
                container.addEventListener('dragleave', () => container.classList.remove('drag-over'));
                container.addEventListener('drop', (e) => {
                    e.preventDefault();
                    container.classList.remove('drag-over');
                    if (!document.getElementById('next-btn').classList.contains('hidden')) return;

                    if (container.classList.contains('drop-zone')) {
                        if (container.hasChildNodes()) document.getElementById('source-area').appendChild(container.firstChild);
                        container.appendChild(draggedElement);
                    } else {
                        document.getElementById('source-area').appendChild(draggedElement);
                    }
                    updateBtnState();
                });
            });
        };

        const updateBtnState = () => {
            const allFilled = Array.from(document.querySelectorAll('.drop-zone')).every(z => z.hasChildNodes());
            document.getElementById('check-btn').disabled = !allFilled;
        };

        const checkAnswer = () => {
            const data = currentLevelData[currentQuestionIndex];
            const dropZones = document.querySelectorAll('.drop-zone');
            const answer = Array.from(dropZones).map(z => z.textContent).join('');
            const isCorrect = answer === data.idiom;

            dropZones.forEach((z, i) => {
                const card = z.firstChild;
                if (answer[i] === data.idiom[i]) {
                    z.classList.add('correct-zone');
                    card.classList.add('correct-card');
                } else {
                    z.classList.add('wrong-zone');
                    card.classList.add('wrong-card');
                }
                card.draggable = false;
                card.onclick = null;
            });

            if (isCorrect) {
                score++;
                document.getElementById('current-score-display').textContent = score;
                document.getElementById('feedback-message').textContent = "„Éü„ÉÉ„Ç∑„Éß„É≥ÊàêÂäüÔºÅ ‚ú®";
                document.getElementById('feedback-message').className = "font-black text-2xl text-emerald-400 italic tracking-tighter";
            } else {
                document.getElementById('feedback-message').textContent = "„Éü„ÉÉ„Ç∑„Éß„É≥Â§±Êïó...";
                document.getElementById('feedback-message').className = "font-black text-2xl text-rose-500 italic tracking-tighter";
            }

            document.getElementById('feedback-area').classList.remove('hidden');
            document.getElementById('check-btn').classList.add('hidden');
            document.getElementById('next-btn').classList.remove('hidden');
        };

        const nextQuestion = () => {
            currentQuestionIndex++;
            if (currentQuestionIndex < currentLevelData.length) {
                showQuestion();
            } else {
                showResult();
            }
        };

        const showResult = () => {
            const finalTime = stopTimer();
            document.getElementById('game-view').classList.add('hidden');
            document.getElementById('result-view').classList.remove('hidden');
            document.getElementById('progress-bar').style.width = '100%';
            
            document.getElementById('final-score').textContent = score;
            document.getElementById('final-time').textContent = finalTime.toFixed(1);
            
            const comments = {
                5: "„Éë„Éº„Éï„Çß„ÇØ„ÉàÔºÅÂêõ„Åì„Åù„Åå„É¨„Ç∏„Çß„É≥„Éâ„Å†„ÄÇ",
                4: "Á¥†Êô¥„Çâ„Åó„ÅÑÔºÅ„ÅÇ„Å®‰∏ÄÊ≠©„ÅßÂÆåÁíß„Å†„Å£„Åü„Åû„ÄÇ",
                3: "„Éä„Ç§„ÇπÔºÅ„Åï„Çâ„Å™„ÇãÈ´ò„Åø„ÇíÁõÆÊåá„Åõ„ÄÇ",
                default: "ÁâπË®ì„ÅåÂøÖË¶Å„Å†„ÄÇ„ÇÇ„ÅÜ‰∏ÄÂ∫¶ÊåëÊà¶„Åó„Çç„ÄÇ"
            };
            document.getElementById('result-comment').textContent = comments[score] || comments.default;
        };

        const backToMenu = () => {
            document.getElementById('result-view').classList.add('hidden');
            document.getElementById('start-view').classList.remove('hidden');
            document.getElementById('level-label').textContent = "„Éü„ÉÉ„Ç∑„Éß„É≥„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ";
            document.getElementById('progress-container').classList.add('hidden');
        };

        const shuffle = (array) => {
            const newArr = [...array];
            for (let i = newArr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArr[i], newArr[j]] = [newArr[j], newArr[i]];
            }
            return newArr;
        };

        // „Ç∞„É≠„Éº„Éê„É´„Å´ÁôªÈå≤Ôºà„Éú„Çø„É≥„ÅÆonclickÁî®Ôºâ
        window.startGame = startGame;
        window.checkAnswer = checkAnswer;
        window.nextQuestion = nextQuestion;
        window.backToMenu = backToMenu;
    </script>
</body>
</html>
